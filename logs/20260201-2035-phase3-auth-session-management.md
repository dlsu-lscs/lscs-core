# Phase 3: Authentication & Session Management - Complete

**Date**: 2026-02-01 20:35
**Phase**: 3 - Authentication & Session Management
**Status**: COMPLETED

## Summary

Implemented session-based authentication for web UI users alongside the existing JWT-based API key system. The system now supports two authentication mechanisms:
- **Web UI Sessions**: Cookie-based sessions with Google OAuth for LSCS members
- **API Keys (JWT)**: Bearer token authentication for external projects

## What Was Done

### 3.1 Session Management
- Created `sessions` table migration (`migrations/20260128150157_add_sessions_table.sql`)
- Added session queries to `query.sql` and regenerated sqlc
- Created session service (`internal/auth/session.go`) with:
  - Cryptographically secure session ID generation (256-bit)
  - Session creation with configurable duration (24h default, 30d for "remember me")
  - Session validation and retrieval
  - Sliding expiration logic (extends session when < 50% time remaining)
  - Background cleanup job (runs hourly to delete expired sessions)
  - Support for multiple sessions per user (different devices)

### 3.2 Google OAuth for Web UI
- Created OAuth handler (`internal/auth/oauth.go`) with endpoints:
  - `GET /auth/google/login` - Initiates OAuth flow, accepts `?remember=true`
  - `GET /auth/google/callback` - Handles OAuth callback, creates session, redirects to frontend
  - `POST /auth/logout` - Deletes session and clears cookie
  - `GET /auth/me` - Returns current user profile (session-protected)
- Cookie settings:
  - `HttpOnly: true` - Not accessible via JavaScript
  - `Secure: true` in production - HTTPS only
  - `SameSite: Lax` - CSRF protection
  - `MaxAge` based on remember me flag

### 3.3 Session Middleware
- Created session middleware (`internal/middlewares/session.go`)
- Validates session from cookie
- Populates `user_id` and `user_email` in request context
- Implements sliding expiration on each request
- Updates last activity timestamp asynchronously

### 3.4 Configuration Updates
- Added new config fields:
  - `GoogleClientSecret` - For OAuth token exchange
  - `OAuthRedirectURL` - OAuth callback URL
  - `SessionSecret` - For session management
  - `SessionDuration` - Default 86400 seconds (24h)
  - `SessionRememberDuration` - Default 2592000 seconds (30d)
- Updated `.env.example` with new variables

### 3.5 Route Updates
- Added `/auth/*` route group for OAuth endpoints
- Added session-protected routes for web UI
- Enabled CORS credentials for cookie support

## Files Changed

**New Files:**
- `internal/auth/session.go` - Session service
- `internal/auth/session_test.go` - Session service tests
- `internal/auth/oauth.go` - OAuth handler
- `internal/middlewares/session.go` - Session middleware

**Modified Files:**
- `query.sql` - Added session queries + GetMemberByEmail
- `schema.sql` - Added sessions table
- `internal/config/config.go` - OAuth/session configuration
- `internal/server/server.go` - Session service initialization
- `internal/server/routes.go` - OAuth routes, CORS credentials
- `internal/repository/` - Regenerated by sqlc
- `.env.example` - New environment variables
- `PLAN.md` - Phase 3 status updates

## New Endpoints

| Method | Path                    | Auth    | Description                   |
|--------|-------------------------|---------|-------------------------------|
| GET    | `/auth/google/login`    | None    | Initiate Google OAuth         |
| GET    | `/auth/google/callback` | None    | Handle OAuth callback         |
| POST   | `/auth/logout`          | None    | Logout (clears session)       |
| GET    | `/auth/me`              | Session | Get current user profile      |

## Environment Variables Added

```env
GOOGLE_CLIENT_SECRET=your_google_client_secret
OAUTH_REDIRECT_URL=http://localhost:8080/auth/google/callback
SESSION_SECRET=your_session_secret_here
SESSION_DURATION=86400
SESSION_REMEMBER_DURATION=2592000
```

## Test Results

All tests pass:
- `internal/auth` - 11 tests (including 6 new session tests)
- `internal/committee` - 1 test
- `internal/database` - 3 tests
- `internal/helpers` - 2 tests
- `internal/member` - 8 tests

## Next Steps

Phase 4: RBAC & Permissions
- Create `roles` and `member_roles` tables
- Implement permission checking functions
- Add position hierarchy enforcement
- Update authorization middleware
