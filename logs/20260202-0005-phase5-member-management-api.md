# Phase 5: Member Management API

**Date**: 2026-02-02  
**Phase**: 5 - Member Management API

## Summary

Implemented member profile management endpoints for the web UI. Members can now view and edit their own profiles, and authorized users can edit other members' profiles. Added `image_url` field to support profile photos.

## Changes

### Database

- Added `image_url VARCHAR(512)` column to `members` table
- Migration: `migrations/20260201235531_add_member_image_url.sql`

### SQL Queries

- Updated `GetMemberInfo`, `GetMemberInfoById`, `ListMembers` to include `image_url`
- Added `UpdateMemberSelf` query for self-profile updates
- Added `UpdateMemberById` query for admin/authorized profile updates

### DTOs (`internal/member/dto.go`)

- Added `ImageURL` field to `FullInfoMemberResponse`
- Added `ImageURL` field to `MemberResponse`
- Added `UpdateSelfRequest` struct for self-editable fields
- Added `UpdateMemberRequest` struct for admin-editable fields

### Handler Endpoints (`internal/member/handler.go`)

- `GET /me` - Returns authenticated user's profile
- `PUT /me` - Updates authenticated user's own profile (self-editable fields only)
- `GET /members/:id` - Returns member profile by ID
- `PUT /members/:id` - Updates member profile (requires authorization via `RequireCanEditMember` middleware)

### Self-Editable Fields

- nickname, telegram, discord, interests, contact_number, fb_link, image_url

### Authorized-Editable Fields

- All self-editable fields + full_name, email, position_id, committee_id, college, program, house_id

### Routes (`internal/server/routes.go`)

- Added `GET /auth/me` → `memberHandler.GetMeHandler`
- Added `PUT /auth/me` → `memberHandler.UpdateMeHandler`
- Added `GET /auth/members/:id` → `memberHandler.GetMemberByIDHandler`
- Added `PUT /auth/members/:id` → `memberHandler.UpdateMemberByIDHandler` with `RequireCanEditMember` middleware

### Tests

- Updated test mocks in `internal/member/handler_test.go` to include `image_url` column
- Updated test mocks in `internal/auth/handler_test.go` to include `image_url` column

## Files Affected

**New Files:**
- `migrations/20260201235531_add_member_image_url.sql`

**Modified Files:**
- `schema.sql` - Added image_url column
- `query.sql` - Updated queries, added update queries
- `internal/repository/*` - Regenerated by sqlc
- `internal/member/dto.go` - Added image_url, new request types
- `internal/member/handler.go` - Added new endpoints
- `internal/server/routes.go` - Added new routes
- `internal/member/handler_test.go` - Updated mocks
- `internal/auth/handler_test.go` - Updated mocks
- `PLAN.md` - Updated Phase 5 status

## Migration

Run migration to add image_url column:
```bash
make migrate-up
```

## Notes

- The `RequireCanEditMember` middleware checks if the actor can edit the target member based on position hierarchy and committee
- Admin role can edit any member
- PUT /members/:id endpoint does not yet enforce field-level permissions (Phase 4 middleware checks only)
- Next step: Phase 6 (Image Upload) will add S3 storage for profile images
