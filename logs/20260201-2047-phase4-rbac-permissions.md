# Phase 4: RBAC & Permissions

**Date**: 2026-02-01  
**Phase**: 4 - RBAC & Permissions

## Summary

Implemented role-based access control (RBAC) system with position hierarchy for member management. The system supports both system-level roles (ADMIN, MODERATOR) and position-based permissions (PRES > EVP > VP > AVP > CT > JO > MEM).

## Changes

### Database

- Created `roles` table for system-level roles
- Created `member_roles` many-to-many table for role assignments
- Added migration: `migrations/20260201204133_add_roles_tables.sql`
- Seeded initial roles: ADMIN, MODERATOR

### RBAC Service (`internal/auth/rbac.go`)

- Position hierarchy mapping with levels 1-7
- `GetPositionLevel()` - Returns authority level for a position
- `IsHigherPosition()` - Compares two positions
- `IsHigherOrEqualPosition()` - For minimum position checks
- `IsAdmin()` - Check if member has ADMIN role
- `HasRole()` - Check for specific role
- `GetMemberRoles()` - Get all roles for a member
- `GrantRole()` / `RevokeRole()` - Role management
- `CanEditMember()` - Complex permission check with hierarchy and committee logic
- `CanViewMember()` - View permission check
- `CanManageRoles()` - Role management permission
- `CanAccessAPIKeyManagement()` - API key access check
- `CanEditField()` / `GetEditableFields()` - Field-level permission checks

### Authorization Middlewares (`internal/middlewares/authorization.go`)

- `RequireAdmin()` - Requires ADMIN role
- `RequireRole()` - Requires specific role
- `RequirePosition()` - Requires minimum position level
- `RequireAPIKeyAccess()` - Requires RND membership or AVP+
- `RequireCanEditMember()` - Requires edit permission for target member
- `RequireAdminOrSelf()` - Requires admin role or same user

### SQL Queries Added

- `GetAllRoles` - List all roles
- `GetRoleById` - Get single role
- `GetMemberRoles` - Get roles for a member
- `HasRole` - Check if member has role
- `GrantRole` - Assign role to member
- `RevokeRole` - Remove role from member
- `GetMembersWithRole` - List members with specific role
- `IsAdmin` - Check for ADMIN role

### Tests

- `internal/auth/rbac_test.go` - Unit tests for position hierarchy and editable fields

## Permission Matrix

| Actor       | Can Edit                                              |
| ----------- | ----------------------------------------------------- |
| MEM, JO, CT | Own profile only                                      |
| AVP         | Own profile only                                      |
| VP          | Own profile + AVP, CT, JO, MEM in same committee      |
| EVP         | Own profile + VP, AVP, CT, JO, MEM (any committee)    |
| PRES        | Own profile + EVP, VP, AVP, CT, JO, MEM (any committee) |
| ADMIN role  | Any member                                            |

## Editable Fields

**Self-editable** (all members on their own profile):
- nickname, telegram, discord, interests, contact_number, fb_link

**Authorized-editable** (higher positions or admin):
- full_name, email, position_id, committee_id, college, program, house_id

## Files Affected

**New Files:**
- `migrations/20260201204133_add_roles_tables.sql`
- `internal/auth/rbac.go`
- `internal/auth/rbac_test.go`

**Modified Files:**
- `schema.sql` - Added roles and member_roles tables
- `query.sql` - Added RBAC queries
- `internal/repository/*` - Regenerated by sqlc
- `internal/middlewares/authorization.go` - Added new middlewares
- `internal/server/server.go` - Added RBACService initialization
- `PLAN.md` - Updated Phase 4 status

## Migration

Run migration to add roles tables:
```bash
make migrate-up
```

## Notes

- The RBAC service is initialized in server.go but middlewares are not yet applied to routes
- Existing `AuthorizationMiddleware` is marked as deprecated; use new RBAC middlewares
- Phase 5 (Member Management API) will apply these middlewares to member editing endpoints
