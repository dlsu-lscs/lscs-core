# Phase 1 Complete: Security & Stability Fixes

**Date**: 2026-01-27

## Summary

Completed all Phase 1 tasks for LSCS Core API, addressing critical security issues and stabilizing the test suite.

## Changes Made

### 1.1 CORS Configuration
- Replaced wildcard CORS origins with environment-based configuration
- Added `ALLOWED_ORIGINS` env var (comma-separated list)
- Defaults to `http://localhost:3000` if not configured

### 1.2 JWT Expiration
- Added `KeyType` enum (`KeyTypeDev`, `KeyTypeProd`, `KeyTypeAdmin`)
- Dev keys: 30 days expiration (configurable via `JWT_DEV_EXPIRY_DAYS`)
- Prod keys: 365 days expiration (configurable via `JWT_PROD_EXPIRY_DAYS`)
- Admin keys: No expiration (backward compatible)
- Updated `GenerateJWT` signature to return expiration time
- Expiration stored in `api_keys.expires_at` column

### 1.3 Panic Removal
- Replaced `log.Fatalf` calls with `slog.Error` + graceful returns
- `Health()` now returns error status instead of crashing
- `New()` returns `nil` on connection error instead of panicking

### 1.4 Input Validation
- Added `go-playground/validator/v10` dependency
- Created `internal/helpers/validation.go` with:
  - `GetValidator()` - singleton validator instance
  - `ValidateStruct()` - validates structs and returns formatted errors
  - `BindAndValidate()` - binds and validates request bodies
- Added validation tags to DTOs (`EmailRequest`, `IdRequest`, `RequestKeyRequest`)
- Validation errors return structured `ValidationErrorResponse`

### 1.5 Test Fixes
- Fixed `auth/handler_test.go`:
  - Updated `mockAuthService.GenerateJWT` to match new signature
  - Added `user_email` to echo context in all tests
  - Fixed request body to use `RequestKeyRequest` instead of `EmailRequest`
  - Updated SQL mock column counts to match 18-column query
- Fixed `member/handler_test.go`:
  - Updated mock rows to include all 18 columns
  - Added helper functions for creating test rows
  - Added validation error test cases

### 1.6 Standardized Error Responses
- Created `internal/helpers/errors.go` with:
  - `APIError` struct for consistent error format
  - Error code constants (`ErrCodeValidation`, `ErrCodeNotFound`, etc.)
  - Helper functions (`ErrBadRequest`, `ErrUnauthorized`, `ErrNotFound`, etc.)

## Files Affected

- `internal/server/routes.go` - CORS configuration
- `internal/auth/service.go` - JWT expiration logic
- `internal/auth/handler.go` - Updated to use new JWT signature, safe context access
- `internal/database/database.go` - Removed panics
- `internal/helpers/validation.go` - New file
- `internal/helpers/errors.go` - New file
- `internal/member/handler.go` - Uses validation helper
- `internal/member/dto.go` - Updated validation tags
- `internal/auth/handler_test.go` - Fixed tests
- `internal/member/handler_test.go` - Fixed tests
- `cmd/gen-token/main.go` - Updated for new JWT signature
- `.env.example` - Added new env vars

## Test Results

All tests pass:
- `internal/auth` - 4 tests
- `internal/committee` - 1 test
- `internal/database` - 3 tests (integration)
- `internal/helpers` - 2 tests
- `internal/member` - 8 tests

## Follow-up

- Phase 2: Foundation Setup (migrations, logging, docs, config)
- Consider adding more validation tests
- Consider adopting standardized error helpers across all existing handlers
